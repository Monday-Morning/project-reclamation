name: Staging CI/CD

on:
  push:
    branches: [main]
    paths:
      - "server/**"

permissions:
  actions: read
  checks: read
  contents: read
  deployments: write
  issues: write
  discussions: write
  packages: write
  pull-requests: write
  repository-projects: read
  security-events: read
  statuses: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NODE_ENV: staging

jobs:
  setup:
    uses: Monday-Morning/project-reclamation/.github/workflows/jobs/setup.yml@main
    with:
      setup_dev: true

  eslint:
    needs: setup
    uses: Monday-Morning/project-reclamation/.github/workflows/jobs/eslint.yml@main
    with:
      reporter: github-check
      fail_on_error: true
      eslint_flags: 'server/'
    secrets:
      github_token: ${{ secrets.GITHUB_TOKEN }}

  prettier:
    needs: setup
    uses: Monday-Morning/project-reclamation/.github/workflows/jobs/prettier.yml@main
    with:
      file_pattern: './server/.'
      config_path: './.prettierrc.yml'
      ignore_path: './.prettierignore'
      fail_on_error: true

  mocha:
    needs: [eslint, prettier]
    uses: Monday-Morning/project-reclamation/.github/workflows/jobs/mocha.yml@main

  build:
    needs: mocha
    uses: Monday-Morning/project-reclamation/.github/workflows/jobs/build.yml@main
    with:
      node_env: ${{ env.NODE_ENV }}
      image_name: ${{ env.IMAGE_NAME }}
      registry: ${{ env.REGISTRY }}
      context: .
      dockerfile: ./Dockerfile
      is_latest: true
    secrets:
      github_token: ${{ secrets.GITHUB_TOKEN }}
